# CVE-2013-3900 Mitigation: Enable Certificate Padding Check (both 64-bit and 32-bit views)
# Run as Administrator

$ErrorActionPreference = 'Stop'

$BasePaths = @(
  'HKLM:\Software\Microsoft\Cryptography\Wintrust',
  'HKLM:\Software\Wow6432Node\Microsoft\Cryptography\Wintrust'
)

foreach ($Base in $BasePaths) {
  try {
    if (-not (Test-Path $Base)) {
      New-Item -Path $Base -Force | Out-Null
    }

    $ConfigKey = Join-Path $Base 'Config'
    if (-not (Test-Path $ConfigKey)) {
      New-Item -Path $ConfigKey -Force | Out-Null
    }

    New-ItemProperty -Path $ConfigKey -Name 'EnableCertPaddingCheck' -PropertyType DWord -Value 1 -Force | Out-Null

    Write-Host "OK  Set EnableCertPaddingCheck=1 at $ConfigKey" -ForegroundColor Green
  }
  catch {
    Write-Host ("ERR Failed at path {0}: {1}" -f $Base, $_.Exception.Message) -ForegroundColor Red
  }
}

# Verify
Write-Host "`nVerification:" -ForegroundColor Cyan
foreach ($Base in $BasePaths) {
  $ConfigKey = Join-Path $Base 'Config'
  if (Test-Path $ConfigKey) {
    $v = (Get-ItemProperty -Path $ConfigKey -Name 'EnableCertPaddingCheck' -ErrorAction SilentlyContinue).EnableCertPaddingCheck
    Write-Host "$ConfigKey -> EnableCertPaddingCheck = $v"
  } else {
    Write-Host "$ConfigKey not found."
  }
}

Write-Host "`nPlease reboot your system to apply the changes." -ForegroundColor Yellow
