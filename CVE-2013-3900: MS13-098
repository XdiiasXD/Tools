<#
.SYNOPSIS
    Remediates CVE-2013-3900 (MS13-098) by enabling EnableCertPaddingCheck.
.DESCRIPTION
    Creates missing registry keys and sets EnableCertPaddingCheck = 1 with full verbose output.
#>

$RegPathParent = "HKLM:\Software\Microsoft\Cryptography\Wintrust"
$RegPath = "$RegPathParent\Config"
$RegName = "EnableCertPaddingCheck"
$DesiredValue = 1
$Changed = $false

Write-Host "`n=== CVE-2013-3900 Remediation Script (Verbose Mode) ===`n" -ForegroundColor Cyan

# Step 1: Create parent path if missing
if (-not (Test-Path $RegPathParent)) {
    Write-Host "Parent path missing: $RegPathParent" -ForegroundColor Yellow
    Write-Host "→ Creating $RegPathParent" -ForegroundColor Yellow
    New-Item -Path $RegPathParent -Force | Out-Null
} else {
    Write-Host "Parent path exists: $RegPathParent" -ForegroundColor Green
}

# Step 2: Create Config path if missing
if (-not (Test-Path $RegPath)) {
    Write-Host "Config path missing: $RegPath" -ForegroundColor Yellow
    Write-Host "→ Creating $RegPath" -ForegroundColor Yellow
    New-Item -Path $RegPath -Force | Out-Null
} else {
    Write-Host "Config path exists: $RegPath" -ForegroundColor Green
}

# Step 3: Check and set the registry value
try {
    $CurrentValue = (Get-ItemProperty -Path $RegPath -Name $RegName -ErrorAction Stop).$RegName
    Write-Host "Current value of $RegName is: $CurrentValue" -ForegroundColor Cyan

    if ($CurrentValue -ne $DesiredValue) {
        Write-Host "→ Updating value from $CurrentValue to $DesiredValue" -ForegroundColor Yellow
        Set-ItemProperty -Path $RegPath -Name $RegName -Type DWord -Value $DesiredValue
        $Changed = $true
    } else {
        Write-Host "Value is already correct ($DesiredValue)" -ForegroundColor Green
    }
}
catch {
    Write-Host "Value $RegName not found under $RegPath" -ForegroundColor Yellow
    Write-Host "→ Creating $RegName and setting to $DesiredValue" -ForegroundColor Yellow
    New-ItemProperty -Path $RegPath -Name $RegName -PropertyType DWord -Value $DesiredValue -Force | Out-Null
    $Changed = $true
}

# Step 4: Verify
$VerifyValue = (Get-ItemProperty -Path $RegPath -Name $RegName).$RegName
if ($VerifyValue -eq $DesiredValue) {
    if ($Changed) {
        Write-Host "SUCCESS: Setting applied. Reboot recommended." -ForegroundColor Green
    } else {
        Write-Host "System was already compliant." -ForegroundColor Green
    }
    Write-Host "Registry location: HKLM\Software\Microsoft\Cryptography\Wintrust\Config\$RegName = $VerifyValue" -ForegroundColor Cyan
} else {
    Write-Host "ERROR: Failed to set $RegName. Please check permissions." -ForegroundColor Red
    exit 1
}

Write-Host "`n=== CVE-2013-3900 check complete ===`n" -ForegroundColor Cyan
